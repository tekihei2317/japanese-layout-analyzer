---
import {
  ortholinearLayout,
  rowStaggeredLayout,
  type KeyboardLayout,
  type KeyboardRow,
  type LoadMetrics,
} from "@japanese-layout-analyzer/core";

type KeyCell = { unit: number; offset?: number; value: number };

const { loadMetrics, layoutId } = Astro.props as {
  loadMetrics?: LoadMetrics;
  layoutId: string;
};

const rowOrder: KeyboardRow[] = [
  "NumberRow",
  "TopRow",
  "MiddleRow",
  "BottomRow",
  "SpaceRow",
];

const fingerOrder: Array<{ key: keyof LoadMetrics["finger"]; label: string }> =
  [
    { key: "LeftPinky", label: "LP" },
    { key: "LeftRing", label: "LR" },
    { key: "LeftMiddle", label: "LM" },
    { key: "LeftIndex", label: "LI" },
    { key: "LeftThumb", label: "LT" },
    { key: "RightThumb", label: "RT" },
    { key: "RightIndex", label: "RI" },
    { key: "RightMiddle", label: "RM" },
    { key: "RightRing", label: "RR" },
    { key: "RightPinky", label: "RP" },
  ];

function toPercent(value: number | undefined) {
  return typeof value === "number" ? value * 100 : 0;
}

function buildKeyRows(
  layout: KeyboardLayout,
  metrics: LoadMetrics | undefined
) {
  return rowOrder.map((row) =>
    layout[row].map((key) => ({
      unit: key.unit,
      offset: key.offset,
      value: toPercent(metrics?.key[key.code]),
    }))
  );
}

function loadClass(value: number) {
  if (value >= 8) return "bg-rose-500/90 text-white";
  if (value >= 6) return "bg-rose-400/90 text-white";
  if (value >= 4) return "bg-rose-300/90 text-rose-900";
  if (value >= 2) return "bg-rose-200/90 text-rose-900";
  if (value >= 1) return "bg-rose-100/90 text-rose-900";
  return "bg-slate-100 text-slate-500";
}

function barWidth(value: number, max: number) {
  return `${Math.round((value / max) * 100)}%`;
}

function barHeight(value: number, max: number) {
  return `${Math.round((value / max) * 100)}%`;
}

const rowSumsLeft = rowOrder.map((row) => toPercent(loadMetrics?.row[row]?.L));
const rowSumsRight = rowOrder.map((row) => toPercent(loadMetrics?.row[row]?.R));
const fingerLoads = fingerOrder.map((finger) => ({
  label: finger.label,
  value: toPercent(loadMetrics?.finger[finger.key]),
}));
const leftSum = toPercent(loadMetrics?.hand.L);
const rightSum = toPercent(loadMetrics?.hand.R);
const maxFinger = Math.max(1, ...fingerLoads.map((entry) => entry.value));
const maxRow = Math.max(1, ...rowSumsLeft, ...rowSumsRight);

const staggeredRows = buildKeyRows(rowStaggeredLayout, loadMetrics);
const ortholinearRows = buildKeyRows(ortholinearLayout, loadMetrics);
const staggeredId = `layout-mode-${layoutId}-staggered`;
const ortholinearId = `layout-mode-${layoutId}-ortholinear`;
---

<div class="mt-8">
  <div class="flex items-center justify-between">
    <h3 class="text-xl font-semibold text-slate-900">負担率</h3>
    <span class="text-sm text-slate-500">%</span>
  </div>

  <div class="mt-4 rounded-2xl border border-slate-200 bg-white p-4">
    <div class="grid gap-6 lg:grid-cols-[1fr_2fr_1fr]">
      <div class="space-y-2 text-[11px] text-slate-600">
        <div class="text-sm font-semibold text-slate-700">行負荷</div>
        {
          rowSumsLeft.map((value) => (
            <div class="flex items-center gap-2">
              <span class="w-10 text-right font-semibold text-slate-600">
                {value.toFixed(1)}
              </span>
              <div class="h-3 flex-1 rounded-full bg-rose-100">
                <div
                  class="ml-auto h-3 rounded-full bg-rose-500"
                  style={`width: ${barWidth(value, maxRow)};`}
                />
              </div>
            </div>
          ))
        }
      </div>

      <div class="space-y-2">
        <div class="text-sm font-semibold text-slate-700">指負荷</div>
        <div
          class="grid gap-2 text-[11px] text-slate-600"
          style={`grid-template-columns: repeat(${fingerLoads.length}, minmax(0, 1fr));`}
        >
          {
            fingerLoads.map((entry) => (
              <div class="flex flex-col items-center gap-2">
                <span class="font-semibold text-slate-600">
                  {entry.value.toFixed(1)}
                </span>
                <div class="flex h-20 w-full items-end justify-center rounded-lg bg-rose-100">
                  <div
                    class="w-full rounded-md bg-rose-500"
                    style={`height: ${barHeight(entry.value, maxFinger)};`}
                  />
                </div>
                <span class="text-[10px] text-slate-500">{entry.label}</span>
              </div>
            ))
          }
        </div>
      </div>

      <div class="space-y-2 text-[11px] text-slate-600">
        <div class="text-sm font-semibold text-slate-700 text-right">
          行負荷
        </div>
        {
          rowSumsRight.map((value) => (
            <div class="flex items-center gap-2">
              <div class="h-3 flex-1 rounded-full bg-rose-100">
                <div
                  class="h-3 rounded-full bg-rose-500"
                  style={`width: ${barWidth(value, maxRow)};`}
                />
              </div>
              <span class="w-10 text-left font-semibold text-slate-600">
                {value.toFixed(1)}
              </span>
            </div>
          ))
        }
      </div>
    </div>

    <div class="mt-4 grid gap-3 text-sm text-slate-600 sm:grid-cols-2">
      <span
        class="rounded-full border border-slate-200 bg-white px-3 py-1 text-center"
      >
        左手合計: {leftSum.toFixed(1)}%
      </span>
      <span
        class="rounded-full border border-slate-200 bg-white px-3 py-1 text-center"
      >
        右手合計: {rightSum.toFixed(1)}%
      </span>
    </div>
  </div>

  <div
    class="mt-4 overflow-x-auto rounded-2xl border border-slate-200 bg-white p-3"
  >
    <div class="layout-switch">
      <input
        type="radio"
        name={`layout-mode-${layoutId}`}
        id={staggeredId}
        value="staggered"
        checked
      />
      <label class="layout-toggle" for={staggeredId}> ロースタッガード </label>
      <input
        type="radio"
        name={`layout-mode-${layoutId}`}
        id={ortholinearId}
        value="ortholinear"
      />
      <label class="layout-toggle" for={ortholinearId}> オーソリニア </label>

      <div class="layout-view layout-view--staggered">
        {
          staggeredRows.map((row) => (
            <div class="key-row">
              {row.map((cell: KeyCell) => (
                <div
                  class={`key-cell ${loadClass(cell.value)}`}
                  style={`width: calc(var(--unit-size) * ${cell.unit}); height: var(--unit-size); margin-left: calc(var(--unit-size) * ${cell.offset ?? 0});`}
                  title={`${cell.value.toFixed(1)}%`}
                >
                  <span class="key-value">{cell.value.toFixed(1)}</span>
                </div>
              ))}
            </div>
          ))
        }
      </div>

      <div class="layout-view layout-view--ortholinear">
        {
          ortholinearRows.map((row) => (
            <div class="key-row">
              {row.map((cell: KeyCell) => (
                <div
                  class={`key-cell ${loadClass(cell.value)}`}
                  style={`width: calc(var(--unit-size) * ${cell.unit}); height: var(--unit-size); margin-left: calc(var(--unit-size) * ${cell.offset ?? 0});`}
                  title={`${cell.value.toFixed(1)}%`}
                >
                  <span class="key-value">{cell.value.toFixed(1)}</span>
                </div>
              ))}
            </div>
          ))
        }
      </div>
    </div>
  </div>
</div>

<style>
  .layout-switch {
    --unit-size: 2.25rem;
    display: grid;
    grid-template-columns: repeat(2, max-content);
    column-gap: 0.5rem;
    row-gap: 0.75rem;
    position: relative;
  }

  .layout-switch input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .layout-toggle {
    display: inline-flex;
    align-items: center;
    border-radius: 9999px;
    border: 1px solid rgb(226 232 240);
    padding: 0.25rem 0.75rem;
    cursor: pointer;
    font-size: 0.75rem;
    color: rgb(71 85 105);
    background: rgb(255 255 255);
  }

  .layout-switch input:checked + .layout-toggle {
    border-color: rgb(248 113 113);
    color: rgb(159 18 57);
    background: rgb(254 226 226);
  }

  .layout-view {
    display: none;
    gap: 0.5rem;
    grid-column: 1 / -1;
  }

  .layout-switch input[value="staggered"]:checked ~ .layout-view--staggered {
    display: grid;
  }

  .layout-switch
    input[value="ortholinear"]:checked
    ~ .layout-view--ortholinear {
    display: grid;
  }

  .key-row {
    display: flex;
    flex-wrap: nowrap;
    gap: 0.5rem;
    min-height: var(--unit-size);
  }

  .key-cell {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.6rem;
    font-size: 0.65rem;
    font-weight: 600;
    position: relative;
    overflow: hidden;
  }

  .key-value {
    padding: 0 0.35rem;
  }
</style>
