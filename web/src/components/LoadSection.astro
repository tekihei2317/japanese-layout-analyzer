---
type LoadView = {
  keyRows: number[][];
  rowSumsLeft: number[];
  rowSumsRight: number[];
  fingerLoads: Array<{ label: string; value: number }>;
  leftSum: number;
  rightSum: number;
  maxFinger: number;
  maxRow: number;
};

const { loadView } = Astro.props as { loadView: LoadView };

function loadClass(value: number) {
  if (value >= 8) return "bg-rose-500/90 text-white";
  if (value >= 6) return "bg-rose-400/90 text-white";
  if (value >= 4) return "bg-rose-300/90 text-rose-900";
  if (value >= 2) return "bg-rose-200/90 text-rose-900";
  if (value >= 1) return "bg-rose-100/90 text-rose-900";
  return "bg-slate-100 text-slate-500";
}

function barWidth(value: number, max: number) {
  return `${Math.round((value / max) * 100)}%`;
}

function barHeight(value: number, max: number) {
  return `${Math.round((value / max) * 100)}%`;
}
---

<div class="mt-8">
  <div class="flex items-center justify-between">
    <h3 class="text-xl font-semibold text-slate-900">負担率</h3>
    <span class="text-sm text-slate-500">%</span>
  </div>

  <div class="mt-4 rounded-2xl border border-slate-200 bg-white p-4">
    <div class="grid gap-6 lg:grid-cols-[1fr_2fr_1fr]">
      <div class="space-y-2 text-[11px] text-slate-600">
        <div class="text-sm font-semibold text-slate-700">行負荷</div>
        {
          loadView.rowSumsLeft.map((value) => (
            <div class="flex items-center gap-2">
              <span class="w-10 text-right font-semibold text-slate-600">
                {value.toFixed(1)}
              </span>
              <div class="h-3 flex-1 rounded-full bg-rose-100">
                <div
                  class="ml-auto h-3 rounded-full bg-rose-500"
                  style={`width: ${barWidth(value, loadView.maxRow)};`}
                />
              </div>
            </div>
          ))
        }
      </div>

      <div class="space-y-2">
        <div class="text-sm font-semibold text-slate-700">指負荷</div>
        <div
          class="grid gap-2 text-[11px] text-slate-600"
          style={`grid-template-columns: repeat(${loadView.fingerLoads.length}, minmax(0, 1fr));`}
        >
          {
            loadView.fingerLoads.map((entry) => (
              <div class="flex flex-col items-center gap-2">
                <span class="font-semibold text-slate-600">
                  {entry.value.toFixed(1)}
                </span>
                <div class="flex h-20 w-full items-end justify-center rounded-lg bg-rose-100">
                  <div
                    class="w-full rounded-md bg-rose-500"
                    style={`height: ${barHeight(entry.value, loadView.maxFinger)};`}
                  />
                </div>
                <span class="text-[10px] text-slate-500">{entry.label}</span>
              </div>
            ))
          }
        </div>
      </div>

      <div class="space-y-2 text-[11px] text-slate-600">
        <div class="text-sm font-semibold text-slate-700 text-right">
          行負荷
        </div>
        {
          loadView.rowSumsRight.map((value) => (
            <div class="flex items-center gap-2">
              <div class="h-3 flex-1 rounded-full bg-rose-100">
                <div
                  class="h-3 rounded-full bg-rose-500"
                  style={`width: ${barWidth(value, loadView.maxRow)};`}
                />
              </div>
              <span class="w-10 text-left font-semibold text-slate-600">
                {value.toFixed(1)}
              </span>
            </div>
          ))
        }
      </div>
    </div>

    <div class="mt-4 grid gap-3 text-sm text-slate-600 sm:grid-cols-2">
      <span
        class="rounded-full border border-slate-200 bg-white px-3 py-1 text-center"
      >
        左手合計: {loadView.leftSum.toFixed(1)}%
      </span>
      <span
        class="rounded-full border border-slate-200 bg-white px-3 py-1 text-center"
      >
        右手合計: {loadView.rightSum.toFixed(1)}%
      </span>
    </div>
  </div>

  <div
    class="mt-4 overflow-x-auto rounded-2xl border border-slate-200 bg-white p-3"
  >
    <div class="min-w-[640px] space-y-2">
      {
        loadView.keyRows.map((row) => (
          <div
            class="grid gap-2"
            style={`grid-template-columns: repeat(${row.length}, minmax(0, 1fr));`}
          >
            {row.map((value) => (
              <div
                class={`group relative flex h-9 items-center justify-center rounded-lg text-[11px] font-semibold ${loadClass(
                  value
                )}`}
                title={`${value.toFixed(1)}%`}
              >
                <span class="truncate px-1">{value.toFixed(1)}</span>
                <div class="pointer-events-none absolute -top-8 hidden rounded-full bg-slate-900 px-2 py-1 text-[10px] text-white shadow-lg group-hover:block">
                  {value.toFixed(1)}%
                </div>
              </div>
            ))}
          </div>
        ))
      }
    </div>
  </div>
</div>
