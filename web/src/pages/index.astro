---
import "../styles/global.css";
import { promises as fs } from "node:fs";
import SiteHeader from "../components/SiteHeader.astro";
import Layout from "../components/Layout.astro";
import LoadSection from "../components/LoadSection.astro";
import MetricsSection from "../components/MetricsSection.astro";

import type { LoadMetrics } from "@japanese-layout-analyzer/core";

type MetricFormat = "percent" | "ratio" | "count";

type MetricDefinition = {
  key: string;
  label: string;
  unit: string;
  format: MetricFormat;
  group?: string;
};

type LayoutMetrics = {
  efficiency: number;
  hand: number;
  strokeMetrics: {
    bigram: {
      sfb: number;
      scissors: number;
    };
    trigram: {
      sfb: number;
      sft: number;
      alt: number;
      altSfs: number;
      rollIn: number;
      rollOut: number;
      oneHandIn: number;
      oneHandOut: number;
      redirect: number;
      redirectSfs: number;
    };
  };
  loadMetrics?: LoadMetrics;
};

type CorpusPayload = {
  schemaVersion: number;
  corpus: {
    id: string;
    name: string;
    source?: string;
  };
  metrics?: MetricDefinition[];
  layouts: Record<string, { name: string; metrics: LayoutMetrics }>;
};

type CorpusIndex = {
  schemaVersion: number;
  corpora: Array<{
    id: string;
    name: string;
    file: string;
  }>;
};

const defaultMetrics: MetricDefinition[] = [
  {
    key: "efficiency",
    label: "打鍵効率",
    unit: "ratio",
    format: "ratio",
    group: "1-gram",
  },
  {
    key: "sfb2",
    label: "SFB (2-gram)",
    unit: "%",
    format: "percent",
    group: "2-gram",
  },
  {
    key: "scissors",
    label: "Scissors",
    unit: "%",
    format: "percent",
    group: "2-gram",
  },
  {
    key: "sfb3",
    label: "SFB (3-gram)",
    unit: "%",
    format: "percent",
    group: "3-gram",
  },
  {
    key: "sfs3",
    label: "SFS (3-gram)",
    unit: "%",
    format: "percent",
    group: "3-gram",
  },
  {
    key: "alt3",
    label: "ALT (3-gram)",
    unit: "%",
    format: "percent",
    group: "3-gram",
  },
  {
    key: "roll3",
    label: "ROLL (3-gram)",
    unit: "%",
    format: "percent",
    group: "3-gram",
  },
  {
    key: "onehand3",
    label: "ONEHAND (3-gram)",
    unit: "%",
    format: "percent",
    group: "3-gram",
  },
  {
    key: "redirect3",
    label: "REDIRECT (3-gram)",
    unit: "%",
    format: "percent",
    group: "3-gram",
  },
  {
    key: "hand",
    label: "Hand use (L)",
    unit: "%",
    format: "percent",
    group: "load",
  },
  {
    key: "inOut",
    label: "In:out roll",
    unit: "ratio",
    format: "ratio",
    group: "3-gram",
  },
];

function formatMetric(value: number | undefined, metric: MetricDefinition) {
  if (value === undefined || Number.isNaN(value)) return "-";
  if (metric.format === "percent") {
    return `${(value * 100).toFixed(1)}%`;
  }
  if (metric.format === "ratio") {
    return value.toFixed(2);
  }
  return value.toLocaleString("en-US");
}

function metricValue(metrics: LayoutMetrics, key: string) {
  const { strokeMetrics } = metrics;
  if (key === "efficiency") return metrics.efficiency;
  if (key === "hand") return metrics.hand;
  if (key === "sfb2") return strokeMetrics.bigram.sfb;
  if (key === "scissors") return strokeMetrics.bigram.scissors;
  if (key === "sfb3")
    return strokeMetrics.trigram.sfb + strokeMetrics.trigram.sft;
  if (key === "sfs3")
    return strokeMetrics.trigram.altSfs + strokeMetrics.trigram.redirectSfs;
  if (key === "alt3")
    return strokeMetrics.trigram.alt + strokeMetrics.trigram.altSfs;
  if (key === "roll3")
    return strokeMetrics.trigram.rollIn + strokeMetrics.trigram.rollOut;
  if (key === "onehand3")
    return strokeMetrics.trigram.oneHandIn + strokeMetrics.trigram.oneHandOut;
  if (key === "redirect3")
    return strokeMetrics.trigram.redirect + strokeMetrics.trigram.redirectSfs;
  if (key === "inOut") {
    const inCount =
      strokeMetrics.trigram.rollIn + strokeMetrics.trigram.oneHandIn;
    const outCount =
      strokeMetrics.trigram.rollOut + strokeMetrics.trigram.oneHandOut;
    return outCount ? inCount / outCount : 0;
  }
  return undefined;
}

async function loadCorpusData() {
  try {
    const indexPath = new URL(
      "../../public/metrics/index.json",
      import.meta.url
    );
    const indexRaw = await fs.readFile(indexPath, "utf8");
    const index = JSON.parse(indexRaw) as CorpusIndex;
    const firstCorpus = index.corpora[0];
    if (!firstCorpus) return null;
    const corpusPath = new URL(
      `../../public${firstCorpus.file}`,
      import.meta.url
    );
    const corpusRaw = await fs.readFile(corpusPath, "utf8");
    return JSON.parse(corpusRaw) as CorpusPayload;
  } catch {
    return null;
  }
}

const corpusData = await loadCorpusData();
const layouts = Object.entries(corpusData?.layouts ?? {});
const metricDefinitions = corpusData?.metrics ?? defaultMetrics;
const layoutViews = layouts.map(([layoutId, entry]) => {
  const metrics = metricDefinitions.map((metric) => ({
    label: metric.label,
    value: formatMetric(metricValue(entry.metrics, metric.key), metric),
  }));
  return { layoutId, entry, metrics };
});
---

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>Japanese Layout Analyzer</title>
  </head>
  <body class="min-h-screen">
    <div class="relative overflow-hidden">
      <div
        class="absolute -top-24 right-10 h-64 w-64 rounded-full bg-teal-100 blur-3xl"
      >
      </div>
      <div
        class="absolute top-24 -left-20 h-72 w-72 rounded-full bg-orange-100 blur-3xl"
      >
      </div>
      <SiteHeader />
      <main
        class="relative mx-auto flex w-full max-w-6xl flex-col gap-10 px-6 py-12"
      >
        <header class="flex flex-col gap-4">
          <div
            class="inline-flex w-fit items-center gap-2 rounded-full border border-slate-200 bg-white/80 px-4 py-1 text-xs uppercase tracking-[0.35em] text-slate-500 shadow-sm"
          >
            Layout Overview
          </div>
          <div class="flex flex-col gap-3">
            <h1 class="text-2xl font-semibold text-slate-900 sm:text-4xl">
              配列指標ダッシュボード
            </h1>
          </div>
          <div class="flex flex-wrap items-center gap-3 text-sm text-slate-600">
            <span class="rounded-full bg-white px-3 py-1 shadow-sm">
              コーパス: 青空文庫（仮）
            </span>
          </div>
        </header>

        <section class="grid gap-8">
          {
            layoutViews.length === 0 && (
              <div class="rounded-3xl border border-dashed border-slate-200 bg-white/90 p-6 text-slate-600">
                exportコマンドで生成したメトリクスが見つかりませんでした。
              </div>
            )
          }
          {
            layoutViews.map((view) => (
              <div class="rounded-3xl border border-slate-200 bg-white/90 p-6 backdrop-blur">
                <div class="flex flex-wrap items-center justify-between gap-3">
                  <h2 class="text-2xl font-semibold text-slate-900">
                    {view.entry.name}
                  </h2>
                </div>

                <div class="mt-6">
                  <Layout />
                </div>

              <LoadSection
                loadMetrics={view.entry.metrics.loadMetrics}
                layoutId={view.layoutId}
              />
                <MetricsSection metrics={view.metrics} />
              </div>
            ))
          }
        </section>
      </main>
    </div>
  </body>
</html>
