---
import "../styles/global.css";
import { promises as fs } from "node:fs";
import SiteHeader from "../components/SiteHeader.astro";
import TableApp from "../components/TableApp";

type CorpusIndex = {
  schemaVersion: number;
  corpora: Array<{
    id: string;
    name: string;
    file: string;
  }>;
};

type MetricFormat = "percent" | "ratio" | "count";

type MetricDefinition = {
  key: string;
  label: string;
  unit: string;
  format: MetricFormat;
  group?: string;
};

type LayoutMetrics = {
  efficiency: number;
  hand: number;
  strokeMetrics: {
    bigram: {
      sfb: number;
      scissors: number;
    };
    trigram: {
      sfb: number;
      sft: number;
      alt: number;
      altSfs: number;
      rollIn: number;
      rollOut: number;
      oneHandIn: number;
      oneHandOut: number;
      redirect: number;
      redirectSfs: number;
    };
  };
};

type CorpusPayload = {
  schemaVersion: number;
  corpus: {
    id: string;
    name: string;
    source?: string;
  };
  metrics?: MetricDefinition[];
  layouts: Record<string, { name: string; metrics: LayoutMetrics }>;
};

async function loadCorpusIndex() {
  const indexPath = new URL("../../public/metrics/index.json", import.meta.url);
  const indexRaw = await fs.readFile(indexPath, "utf8");
  return JSON.parse(indexRaw) as CorpusIndex;
}

async function loadCorpusData(file: string) {
  const corpusPath = new URL(`../../public${file}`, import.meta.url);
  const corpusRaw = await fs.readFile(corpusPath, "utf8");
  return JSON.parse(corpusRaw) as CorpusPayload;
}

const index = await loadCorpusIndex();
const corpusEntries = await Promise.all(
  index.corpora.map(async (corpus) => {
    const payload = await loadCorpusData(corpus.file);
    return [corpus.id, payload] as const;
  })
);
const corpusDataById = Object.fromEntries(corpusEntries);
---

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>指標テーブル | Japanese Layout Analyzer</title>
  </head>
  <body class="min-h-screen">
    <div class="relative overflow-hidden">
      <div
        class="absolute -top-24 right-10 h-64 w-64 rounded-full bg-teal-100 blur-3xl"
      >
      </div>
      <div
        class="absolute top-32 -left-16 h-72 w-72 rounded-full bg-orange-100 blur-3xl"
      >
      </div>
      <SiteHeader />
      <main
        class="relative mx-auto flex w-full max-w-screen-2xl flex-col gap-8 px-6 py-12"
      >
        <header class="flex flex-col gap-4">
          <div class="flex flex-col gap-3">
            <h1 class="text-2xl font-semibold text-slate-900 sm:text-3xl">
              配列評価テーブル
            </h1>
            <p class="max-w-2xl text-base text-slate-600 sm:text-lg">
              コーパス×配列の組み合わせから、主要指標を一覧で比較します。
            </p>
          </div>
        </header>

        <section
          class="rounded-3xl border border-slate-200 bg-white/90 p-6 backdrop-blur"
        >
          <TableApp
            client:load
            index={index}
            corpusDataById={corpusDataById}
          />
        </section>
      </main>
    </div>
  </body>
</html>
